# AODW Token 消耗分析与优化建议

## 1. 问题确认

用户反馈使用 AODW 过程中非常消耗 AI 的 token。经过分析，确实存在这个问题。

### 1.1 Token 消耗统计

**总体情况**：
- 规则文件总数：46 个
- 总文件大小：283.3 KB
- 估算总 token：~72,504 tokens

**典型工作流消耗**：
- **创建新 RT (Spec-Lite)**：~16,338 tokens（6 个文件，63.8 KB）
- **创建新 RT (Spec-Full)**：~24,275 tokens（8 个文件，94.8 KB）
- **UI 相关任务**：~9,055 tokens（7 个文件，35.4 KB）
- **代码实现阶段**：~10,971 tokens（5 个文件，42.9 KB）

### 1.2 主要问题

1. **强制文件加载过多**
   - 每次创建 RT 都需要读取多个大文件（3-8 个）
   - UI 任务需要额外读取 4 个 ui-kit 文件
   - 审计阶段需要读取大型审计规则文件（17KB+）

2. **文件大小问题**
   - 最大的文件：18KB+（python-fastapi 编码规范）
   - 多个文件超过 10KB
   - 审计规则文件特别大（17KB+）

3. **重复加载可能性**
   - 某些文件被多次引用（如 `ai-coding-rules-common.md` 被引用 15 次）
   - 不同阶段可能重复加载相同文件

4. **缺乏按需加载机制**
   - 规则要求"必须读取"，但没有明确"何时读取"
   - 没有区分"必须立即读取"和"按需读取"

---

## 2. 优化建议

### 2.1 按需加载策略（推荐）

**核心原则**：只在需要时读取相关文件，而不是一次性加载所有文件。

#### 优化方案 A：阶段化加载

**当前问题**：
- 创建 RT 时一次性加载 6-8 个文件
- 所有文件都在上下文中，即使当前阶段不需要

**优化方案**：
- **阶段 1（创建 RT）**：只加载 `rt-manager.md`、`ai-interaction-rules.md`、`rt-id-generation-rules.md`
- **阶段 2（Intake）**：按需加载 `ai-interaction-rules.md`（如果未加载）
- **阶段 3（决策）**：按需加载 `spec-full-profile.md` 或 `spec-lite-profile.md`
- **阶段 4（Spec/Plan）**：按需加载相关规范文件
- **阶段 5（实现）**：按需加载编码规范文件
- **阶段 6（审计）**：按需加载审计规则文件

#### 优化方案 B：摘要索引模式

**核心思路**：为大型文件创建摘要版本，AI 先读取摘要，需要详细信息时再读取完整文件。

**实施方式**：
1. 为每个大型规则文件创建 `xxx-summary.md`（1-2KB）
2. 摘要包含：核心规则、关键检查点、详细规则位置
3. AI 先读取摘要，根据摘要决定是否需要读取完整文件

**示例**：
```
.aodw/03-standards/ai-coding-rules-summary.md  (摘要，~1KB)
.aodw/03-standards/ai-coding-rules.md         (完整版，~11KB)
```

### 2.2 UI-Kit 优化

**当前问题**：
- UI 任务需要读取 4 个 ui-kit 文件（~670 tokens）
- 这些文件内容相对简单，可以合并或精简

**优化方案**：
1. **合并文件**：将 4 个文件合并为 1 个 `ui-kit.md`（~2KB）
2. **精简内容**：移除冗余说明，保留核心规则
3. **按需加载**：只在 UI 任务时加载，非 UI 任务不加载

### 2.3 审计规则优化

**当前问题**：
- 审计规则文件特别大（17KB+，~4,350 tokens）
- 每次审计都需要加载完整文件

**优化方案**：
1. **拆分文件**：按审计类型拆分（需求审计、开发审计、综合审计）
2. **摘要模式**：创建摘要版本，只包含核心检查点
3. **按需加载**：只在执行审计时加载，不提前加载

### 2.4 编码规范优化

**当前问题**：
- 编码规范文件被频繁引用（15+ 次）
- 文件较大（11KB+）
- 可能在不同阶段重复加载

**优化方案**：
1. **缓存机制**：如果已加载过，不再重复加载
2. **摘要版本**：创建摘要，只包含关键规则
3. **按技术栈分离**：前端/后端规范分开，只加载相关的

### 2.5 规则文件精简

**当前问题**：
- 某些文件包含大量示例代码和说明
- 可以精简为核心规则

**优化方案**：
1. **移除冗余示例**：保留 1-2 个关键示例即可
2. **精简说明**：移除重复说明，保留核心规则
3. **外部化示例**：将详细示例移到单独文件

---

## 3. 实施优先级

### 高优先级（立即实施）

1. **明确按需加载规则**
   - 更新规则文件，明确"何时读取"而不是"必须读取"
   - 区分"必须立即读取"和"按需读取"

2. **UI-Kit 文件合并**
   - 将 4 个文件合并为 1 个
   - 精简内容，保留核心规则

3. **创建文件加载指南**
   - 明确每个阶段需要加载哪些文件
   - 避免重复加载

### 中优先级（后续优化）

4. **创建摘要版本**
   - 为大型文件创建摘要版本
   - AI 先读取摘要，需要时再读取完整版

5. **审计规则拆分**
   - 按审计类型拆分文件
   - 减少单次加载的文件大小

6. **编码规范优化**
   - 创建摘要版本
   - 实施缓存机制

### 低优先级（长期优化）

7. **规则文件精简**
   - 移除冗余内容
   - 外部化详细示例

8. **智能加载系统**
   - 根据任务类型自动选择需要加载的文件
   - 实施文件依赖关系管理

---

## 4. 具体优化措施

### 4.1 更新规则文件，明确加载时机

**当前表述**：
> AI **必须**先读取并理解以下文件

**优化后**：
> AI **必须**在 [具体阶段/条件] 时读取并理解以下文件：
> - 如果 [条件 A]：读取文件 X
> - 如果 [条件 B]：读取文件 Y
> - 否则：跳过

### 4.2 创建文件加载指南

在 `aodw-constitution.md` 中添加"文件加载策略"章节，明确：
- 每个阶段需要加载哪些文件
- 哪些文件可以按需加载
- 哪些文件可以缓存

### 4.3 优化 UI-Kit 文件

- 合并 4 个文件为 1 个 `ui-kit.md`
- 精简内容，保留核心规则
- 总大小控制在 2KB 以内

---

## 5. 预期效果

实施优化后，预期可以：

1. **减少 50-70% 的 token 消耗**
   - Spec-Lite RT 创建：从 ~16K tokens 降至 ~5-8K tokens
   - Spec-Full RT 创建：从 ~24K tokens 降至 ~8-12K tokens
   - UI 任务：从 ~9K tokens 降至 ~2-3K tokens

2. **提升响应速度**
   - 减少文件加载时间
   - 减少上下文处理时间

3. **保持功能完整性**
   - 所有核心功能保持不变
   - 只是优化了加载策略

---

## 6. 风险评估

### 6.1 潜在风险

1. **按需加载可能导致遗漏**
   - 风险：AI 可能忘记在需要时加载文件
   - 缓解：明确的加载指南和检查清单

2. **摘要版本可能信息不足**
   - 风险：摘要可能遗漏关键信息
   - 缓解：摘要包含完整文件的引用，需要时可读取

3. **用户学习成本**
   - 风险：新的加载策略需要用户理解
   - 缓解：提供清晰的文档和示例

### 6.2 兼容性

- 优化后的规则应该向后兼容
- 支持"完整加载"和"按需加载"两种模式
- 用户可以选择使用哪种模式

---

## 7. 下一步行动

1. **立即行动**：
   - 更新规则文件，明确加载时机
   - 合并 UI-Kit 文件
   - 创建文件加载指南

2. **短期行动**（1-2 周）：
   - 创建摘要版本
   - 优化审计规则
   - 实施缓存机制

3. **长期行动**（1 个月+）：
   - 规则文件精简
   - 智能加载系统
   - 性能监控和优化

