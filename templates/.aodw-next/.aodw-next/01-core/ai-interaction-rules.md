0. UI 任务判断（前置检查）

在执行任何任务之前，AI 必须首先进行 **任务类型判断**，识别是否为 UI 相关任务。

### 0.1 UI 相关任务判定条件

以下任意条件满足，即视为 **UI 相关任务**：
- ✅ 涉及页面、界面、布局、组件、表单、Dashboard
- ✅ 涉及用户操作流程、交互体验、可视化
- ✅ 涉及前端 UI、样式、视觉呈现
- ✅ 用户明确提到"界面 / UI / 好看 / 丑 / 设计"
- ✅ 涉及 UI 改造、UI 新建、UI 优化

### 0.2 判断时机

- **RT 创建阶段**：在 `intake.md` 生成时进行判断
- **任务执行阶段**：在执行任何代码修改前进行判断
- **需求变更阶段**：当用户提出新需求时重新判断

### 0.3 判断结果处理

- **非 UI 相关任务**：按正常 AODW 流程执行
- **UI 相关任务**：**必须进入 UI 专用流程**

> **详细规则**：请参考 `.aodw/02-workflow/ui-workflow-rules.md`

---

1. 问题类型（两大类）
AI 所提出的所有问题必须明确属于：
	1.	决策型（Decision Question）
	•	必须提供选项
	•	必须明确推荐项
	•	必须给出推荐理由
	•	必须支持 "custom: …"（≤ 5 个词）
	2.	信息型（Information Question）
	•	用于收集信息
	•	必须提供示例答案
	•	必须限制用户输入不超过 10 个词
	•	必须保证问题可被快速回答

⸻

2. 问题的格式规范
所有问题必须遵守格式（AI 必须严格采用）：
Q1. <问题内容>

A. <选项1>
B. <选项2>
C. <选项3>
D. <选项4>

Recommended: B（理由：……）

请回复：A/B/C/D 或 custom:<你的答案>

信息型问题格式：
Q2. <要确认的信息>

示例答案：
- "订单服务"
- "支付模块"
- "只影响前端"

请给我一个 ≤10个词的回答。

3. 每轮最多提出的问题数量
	•	🚫 单轮禁止提出超过 5 个问题
	•	建议每轮 3 个 以内
	•	超过 3 个必须提示用户原因（例如：需求范围大，需要更多澄清）

⸻

4. AI 问题的节奏（Flow Control）
AI 必须遵守：
	•	不得一次性问一大堆问题
	•	必须逐步推进（Ask → Wait → Respond → Continue）
	•	每轮问题结束后必须总结本轮收集到的信息
	•	不能在用户未回答的情况下继续提出下一组问题

⸻

5. 用户中断与暂停机制
AI 必须支持以下命令：
	•	"先暂停 AODW"
	•	"等一下，不继续流程"
	•	"跳过这一步"

AI 必须立即：
	•	停止流程推进
	•	切换到「普通代码助手模式」
	•	并要求用户说"继续 AODW"才能回到流程

⸻

5.5. UI 流程主动触发机制

用户可以在任何时候主动触发 UI 相关流程，AI 必须识别并执行以下命令：

### 5.5.1 UI 流程触发命令识别

AI 必须识别以下用户指令（支持多种表达方式）：

| 触发类型 | 触发词示例 | 执行动作 |
|---------|-----------|---------|
| **UI 设计** | "请 AODW 规范，帮我就当前这个 RT 任务的界面进行设计"<br>"按 AODW 规范设计界面"<br>"设计 UI"<br>"生成界面原型" | 执行 UI 设计流程（规则文件读取 → UI 结构与设计说明 → 静态 HTML 原型生成 → 用户确认） |
| **UI 审计/审查** | "请 AODW 规范，帮我就当前这个 RT 任务的界面进行审计"<br>"审计界面"<br>"审查 UI"<br>"检查界面" | 执行 UI Critic 审查流程（切换到 UI Critic 角色，按 `.aodw/03-standards/ui-kit/ui-kit.md` 第 4 节标准审查） |
| **UI 挑毛病** | "请 AODW 规范，帮我就当前这个 RT 任务的界面挑毛病"<br>"挑 UI 毛病"<br>"找界面问题"<br>"UI 有什么问题" | 执行 UI Critic 审查流程（严格审查，指出所有问题） |

### 5.5.2 触发条件检查

当用户触发 UI 流程时，AI 必须：

1. **检查当前 RT 上下文**
   - 确认是否存在当前 RT（检查 `RT/RT-XXX/` 目录）
   - 如果不存在，提示用户："未找到当前 RT，请先创建或打开一个 RT"
   - 如果存在，读取 `intake.md` 或 `spec.md` / `spec-lite.md` 了解任务内容

2. **检查是否为 UI 相关任务**
   - 如果 `intake.md` 中标注了 `ui_related: true`，直接进入 UI 流程
   - 如果未标注，但任务涉及 UI（根据第 0 节判断），提示用户："检测到当前 RT 可能涉及 UI，是否执行 UI 流程？"
   - 如果完全不涉及 UI，提示用户："当前 RT 不涉及 UI，是否仍要执行 UI 审查？"

3. **执行对应的 UI 流程**
   - **UI 设计**：按照 `.aodw/02-workflow/ui-workflow-rules.md` 第 2 节执行
   - **UI 审计/审查/挑毛病**：按照 `.aodw/02-workflow/ui-workflow-rules.md` 第 3 节执行

### 5.5.3 执行响应模板

当用户触发 UI 流程时，AI 应回复：

```
✅ **UI 流程已触发**
- 当前 RT：[RT-XXX]
- 触发类型：[设计 / 审计 / 挑毛病]
- 执行动作：[具体要执行的内容]
- 参考规范：[.aodw/03-standards/ui-kit/ui-kit.md]
```

### 5.5.4 执行优先级

- **用户主动触发** > **自动流程触发**
- 如果用户主动触发 UI 流程，即使当前不在 UI 相关阶段，也应立即执行
- 执行完成后，询问用户是否继续原流程

⸻

6. 错误恢复机制
如果用户回答不清晰或违背格式，AI 必须：
	•	或再次提出简化问题
	•	并提供新的建议选项

⸻

7. 透明度与确认机制

AI 必须主动维护流程的透明度：
- **复杂任务追踪**：当任务步骤超过 3 步时，必须创建 `task.md` 并实时更新。
  - **任务追踪检查**：
    - 在执行复杂任务时，AI 应在每个阶段结束后主动检查 task.md 是否需要更新
    - 如果发现 task.md 已过时，必须立即更新并告知用户
    - 在每次提交代码前，AI 必须检查 task.md 是否已更新到最新状态
- **关键节点确认**：
  - Plan 完成后，必须暂停并请求批准。
  - 代码提交前，必须暂停并请求确认。

⸻

8. 门禁检查点与用户确认

> **重要**：详细的门禁检查点定义见 `aodw-constitution.md` 第 4.5 节。

### 8.1 确认词汇表

AI 必须识别以下用户确认指令：

| 确认类型     | 触发词                           | 范围                             |
| ------------ | -------------------------------- | -------------------------------- |
| **单步确认** | "继续"、"下一步"、"好"、"ok"     | 只批准当前 Gate，进入下一阶段    |
| **批准执行** | "批准"、"执行"、"approved"、"go" | 批准 Plan，允许开始编码          |
| **跳过确认** | "跳过"、"skip"                   | 跳过当前检查点（需二次确认风险） |
| **暂停流程** | "暂停"、"pause"、"等等"、"停"    | 暂停 AODW 流程，切换到普通模式   |
| **启动审计** | "审计"、"audit"                  | 启动对应阶段的审计               |

### 8.2 确认边界

**关键规则**：
- ⚠️ 用户说"继续"只意味着"通过当前 Gate"，**不是"执行到底"**
- ⚠️ AI 必须在下一个 Gate 再次等待确认
- ⚠️ 默认模式下，每个 Gate 只能通过一个确认

### 8.3 确认后响应模板

当用户确认后，AI 应回复：

```
✅ **确认收到**
- 当前操作：[刚才批准的内容]
- 正在执行：[即将做的事情]
- 下一检查点：[下一个 Gate 的位置]
```

⸻

9. 分支验证前置

AI 在执行任何代码修改操作（`write_to_file`、`replace_file_content`）前，必须：

1. 运行 `git branch --show-current`
2. 检查结果：
   - ✅ 如果显示 `feature/RT-XXX-xxx`：继续执行
   - ❌ 如果显示 `main` 或 `master`：**立即停止**
3. 如果在 main/master 分支：
   - 提示用户当前在主分支
   - 询问是否创建 feature 分支
   - 创建并切换到分支后才能继续

**违规处理**：如果 AI 在 main/master 分支上修改了业务代码，必须立即回滚。